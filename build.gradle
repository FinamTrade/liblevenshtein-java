apply plugin: 'java'
apply plugin: 'findbugs'

repositories {
  mavenCentral()
}

archivesBaseName = 'liblevenshtein'
version = '2.1.0'

sourceCompatibility = 1.8
targetCompatibility = 1.8

configurations {
  shell
}

dependencies {
  compile 'com.google.code.findbugs:annotations:3.+'
  compile 'org.projectlombok:lombok:1.+'
  compile 'org.apache.commons:commons-lang3:3.+'
  compile 'it.unimi.dsi:fastutil:6.+'
  compile 'com.google.guava:guava:18.+'
  testCompile 'org.testng:testng:6.+'
  shell 'commons-cli:commons-cli:1.+'
  shell('jline:jline:2.+') {
    exclude(group: 'junit', module: 'junit')
  }
  shell 'org.codehaus.groovy:groovy-groovysh:2.+'
}

tasks.withType(JavaCompile) {
  options.compilerArgs << "-Xlint:unchecked"
}

test {
  useTestNG()

  testLogging {
    exceptionFormat "full"
    showStandardStreams true
    showExceptions true
    showStackTraces true
  }
}

// create syntastic classpath files
task syntastic << {
  description = 'Dumps the classpaths a file that can be read by Syntastic.vim'
  def classpathFiles = new HashSet<String>()
  def addJars = { proj ->
    proj.configurations.each { conf ->
      conf.each { jar ->
        classpathFiles.add(jar)
      }
    }
    proj.sourceSets.each { srcSet ->
      srcSet.java.srcDirs.each { dir ->
        println dir.absolutePath
        classpathFiles.add(dir.absolutePath)
      }
    }
  }
  getChildProjects().each { proj ->
    addJars(proj.value)
  }
  addJars(rootProject)

  // create .vimrc.local
  def vimrc = new File(rootProject.projectDir.absolutePath + "/.vimrc.local")

  classpathFiles << rootProject.projectDir.absolutePath + "/build/classes/main"
  classpathFiles << rootProject.projectDir.absolutePath + "/build/classes/test"

  vimrc.text = """\
let g:syntastic_java_javac_classpath = '${classpathFiles.collect().join(":")}'
"""

  println "Created .vimrc.local, don't forget to source this in your vim config"
}

task(shell, dependsOn: 'classes') << {
  def classpath = sourceSets.main.runtimeClasspath + configurations.shell

  def command = [
    'java',
    '-cp', classpath.collect().join(System.getProperty('path.separator')),
    'org.codehaus.groovy.tools.shell.Main',
    '--color'
  ]

  def proc = new ProcessBuilder(command)
    .redirectOutput(ProcessBuilder.Redirect.INHERIT)
    .redirectInput(ProcessBuilder.Redirect.INHERIT)
    .redirectError(ProcessBuilder.Redirect.INHERIT)
    .start()

  proc.waitFor()

  if (0 != proc.exitValue()) {
    throw new RuntimeException("shell exited with status: ${proc.exitValue()}")
  }
}

tasks.withType(FindBugs) {
  reports {
    xml.enabled = false
    html.enabled = true
  }
}
